<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collateralized Loan dApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" type="application/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .btn {
            @apply inline-block px-6 py-2.5 text-white font-medium text-xs leading-tight uppercase rounded-md shadow-md hover:shadow-lg focus:shadow-lg focus:outline-none focus:ring-0 active:shadow-lg transition duration-150 ease-in-out;
        }

        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 focus:bg-blue-700 active:bg-blue-800;
        }

        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600 focus:bg-gray-600 active:bg-gray-700;
        }

        .btn-success {
            @apply bg-green-500 hover:bg-green-600 focus:bg-green-600 active:bg-green-700;
        }

        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 focus:bg-red-700 active:bg-red-800;
        }

        .card {
            @apply bg-white rounded-lg shadow-md p-6;
        }

        .input {
            @apply block w-full px-3 py-1.5 text-base font-normal text-gray-700 bg-white bg-clip-padding border border-solid border-gray-300 rounded-md transition ease-in-out m-0 focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Collateralized Loan dApp</h1>
            <p class="text-md text-gray-600 mt-2">A peer-to-peer lending platform on the blockchain.</p>
        </header>

        <div class="card mb-6 text-center">
            <button id="connectButton" class="btn btn-primary">Connect Wallet</button>
            <div id="connectionStatus" class="mt-4 hidden">
                <p><strong>Status:</strong> <span id="statusText" class="text-green-600">Connected</span></p>
                <p><strong>Account:</strong> <span id="accountAddress" class="font-mono text-sm"></span></p>
            </div>
        </div>

        <main id="app" class="hidden space-y-8">
            <!-- Request a Loan Section -->
            <section class="card">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Request a New Loan</h2>
                <form id="requestLoanForm" class="space-y-4">
                    <div>
                        <label for="collateralAmount" class="block mb-2 text-sm font-medium">Collateral Amount
                            (ETH)</label>
                        <input type="text" id="collateralAmount" class="input" placeholder="e.g., 1.5" required>
                    </div>
                    <div>
                        <label for="interestRate" class="block mb-2 text-sm font-medium">Interest Rate (%)</label>
                        <input type="number" id="interestRate" class="input" placeholder="e.g., 5" min="1" max="100"
                            required>
                    </div>
                    <div>
                        <label for="duration" class="block mb-2 text-sm font-medium">Duration (in days)</label>
                        <input type="number" id="duration" class="input" placeholder="e.g., 30" min="1" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Request Loan</button>
                </form>
            </section>

            <!-- Available Loans Section -->
            <section class="card">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Available Loans</h2>
                <div id="loansList" class="space-y-4">
                    <p class="text-center text-gray-500">No loans found or still loading...</p>
                </div>
            </section>
        </main>

        <!-- Notification Area -->
        <div id="notification"
            class="fixed bottom-5 right-5 bg-blue-600 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-opacity duration-300">
            <p id="notificationText"></p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONTRACT_ADDRESS = "0x5fbdb2315678afecb367f032d93f642f64180aa3";
        const CONTRACT_ABI = [ 
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "loanId",
                        "type": "uint256"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "lender",
                        "type": "address"
                    }
                ],
                "name": "CollateralClaimed",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "loanId",
                        "type": "uint256"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "lender",
                        "type": "address"
                    }
                ],
                "name": "LoanFunded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "loanId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "totalPaid",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "bool",
                        "name": "rebateApplied",
                        "type": "bool"
                    }
                ],
                "name": "LoanRepaid",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "loanId",
                        "type": "uint256"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "borrower",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "collateralAmount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "loanAmount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "interestRate",
                        "type": "uint256"
                    }
                ],
                "name": "LoanRequested",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "LTV_RATIO",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "REBATE_PERCENT",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_loanId",
                        "type": "uint256"
                    }
                ],
                "name": "claimCollateral",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_interestRate",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_duration",
                        "type": "uint256"
                    }
                ],
                "name": "depositCollateralAndRequestLoan",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_loanId",
                        "type": "uint256"
                    }
                ],
                "name": "fundLoan",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "loans",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "borrower",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "lender",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "collateralAmount",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "loanAmount",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "interestRate",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "dueDate",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bool",
                        "name": "isFunded",
                        "type": "bool"
                    },
                    {
                        "internalType": "bool",
                        "name": "isRepaid",
                        "type": "bool"
                    },
                    {
                        "internalType": "bool",
                        "name": "rebateApplied",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "nextLoanId",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_loanId",
                        "type": "uint256"
                    }
                ],
                "name": "repayLoan",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            }
        ];
        // -------------------

        let provider;
        let signer;
        let contract;

        const connectButton = document.getElementById('connectButton');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        const accountAddress = document.getElementById('accountAddress');
        const app = document.getElementById('app');
        const requestLoanForm = document.getElementById('requestLoanForm');
        const loansList = document.getElementById('loansList');

        connectButton.addEventListener('click', connectWallet);

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showNotification("MetaMask is not installed!", "error");
                return;
            }

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                const address = await signer.getAddress();
                accountAddress.textContent = address;
                statusText.textContent = "Connected";
                connectionStatus.classList.remove('hidden');
                connectButton.classList.add('hidden');
                app.classList.remove('hidden');

                showNotification("Wallet connected successfully!");
                await displayLoans();

                // Listen for contract events to auto-update UI
                contract.on("LoanRequested", (loanId, borrower) => {
                    showNotification(`New Loan #${loanId} requested by ${borrower.slice(0, 6)}...`);
                    displayLoans();
                });
                contract.on("LoanFunded", (loanId) => {
                    showNotification(`Loan #${loanId} has been funded!`);
                    displayLoans();
                });
                contract.on("LoanRepaid", (loanId) => {
                    showNotification(`Loan #${loanId} has been repaid!`);
                    displayLoans();
                });
                contract.on("CollateralClaimed", (loanId) => {
                    showNotification(`Collateral for Loan #${loanId} has been claimed.`);
                    displayLoans();
                });

            } catch (error) {
                console.error("Failed to connect wallet:", error);
                showNotification("Failed to connect wallet.", "error");
                statusText.textContent = "Connection Failed";
                statusText.classList.remove('text-green-600');
                statusText.classList.add('text-red-600');
            }
        }

        async function displayLoans() {
            if (!contract) return;
            loansList.innerHTML = '<p class="text-center text-gray-500">Loading loans...</p>';

            try {
                const nextLoanId = await contract.nextLoanId();
                if (nextLoanId.eq(0)) {
                    loansList.innerHTML = '<p class="text-center text-gray-500">No loans have been created yet.</p>';
                    return;
                }

                let html = '';
                for (let i = 0; i < nextLoanId; i++) {
                    const loan = await contract.loans(i);
                    html += createLoanCard(i, loan);
                }
                loansList.innerHTML = html;
            } catch (error) {
                console.error("Could not fetch loans:", error);
                loansList.innerHTML = '<p class="text-center text-red-500">Could not fetch loans. Check console.</p>';
            }
        }

        function createLoanCard(id, loan) {
            const isMyLoan = signer && loan.borrower.toLowerCase() === signer.getAddress().toLowerCase();
            const canFund = !loan.isFunded;
            const canRepay = loan.isFunded && !loan.isRepaid && isMyLoan;
            const canClaim = loan.isFunded && !loan.isRepaid && !isMyLoan && (new Date().getTime() / 1000 > loan.dueDate);

            let statusPill;
            if (loan.isRepaid) statusPill = `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Repaid</span>`;
            else if (loan.isFunded) statusPill = `<span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Funded</span>`;
            else statusPill = `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Awaiting Funds</span>`;

            const dueDate = new Date(loan.dueDate * 1000).toLocaleString();

            return `
                <div class="border rounded-lg p-4 bg-gray-50">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold">Loan #${id}</h3>
                        ${statusPill}
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <p><strong>Borrower:</strong> <span class="font-mono">${loan.borrower.slice(0, 10)}...</span></p>
                        <p><strong>Lender:</strong> <span class="font-mono">${loan.lender.startsWith('0x00') ? 'N/A' : loan.lender.slice(0, 10) + '...'}</span></p>
                        <p><strong>Collateral:</strong> ${ethers.utils.formatEther(loan.collateralAmount)} ETH</p>
                        <p><strong>Loan Amount:</strong> ${ethers.utils.formatEther(loan.loanAmount)} ETH</p>
                        <p><strong>Interest:</strong> ${loan.interestRate}%</p>
                        <p><strong>Due Date:</strong> ${dueDate}</p>
                    </div>
                    <div class="mt-4 pt-4 border-t flex space-x-2">
                        ${canFund ? `<button class="btn btn-success flex-grow" onclick="fundLoan(${id}, '${loan.loanAmount}')">Fund Loan</button>` : ''}
                        ${canRepay ? `<button class="btn btn-primary flex-grow" onclick="repayLoan(${id}, '${loan.loanAmount}', ${loan.interestRate})">Repay Loan</button>` : ''}
                        ${canClaim ? `<button class="btn btn-danger flex-grow" onclick="claimCollateral(${id})">Claim Collateral</button>` : ''}
                    </div>
                </div>
            `;
        }

        // --- Contract Interaction Functions ---

        requestLoanForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const collateral = document.getElementById('collateralAmount').value;
            const interest = document.getElementById('interestRate').value;
            const durationDays = document.getElementById('duration').value;
            const durationSeconds = durationDays * 24 * 60 * 60;

            try {
                const collateralWei = ethers.utils.parseEther(collateral);
                showNotification("Sending loan request transaction...");
                const tx = await contract.depositCollateralAndRequestLoan(interest, durationSeconds, { value: collateralWei });
                await tx.wait();
                showNotification("Loan request successful!", "success");
            } catch (error) {
                console.error("Loan request failed:", error);
                showNotification(error.data ? error.data.message : error.message, "error");
            }
        });

        async function fundLoan(id, amount) {
            try {
                showNotification(`Funding Loan #${id}...`);
                const tx = await contract.fundLoan(id, { value: amount });
                await tx.wait();
                showNotification("Loan funded successfully!", "success");
            } catch (error) {
                console.error("Fund loan failed:", error);
                showNotification(error.data ? error.data.message : error.message, "error");
            }
        }

        async function repayLoan(id, amount, interestRate) {
            const loanAmount = ethers.BigNumber.from(amount);
            const interest = loanAmount.mul(interestRate).div(100);
            const totalDue = loanAmount.add(interest); // Note: this doesn't account for rebate, contract does.

            try {
                showNotification(`Repaying Loan #${id}...`);
                const tx = await contract.repayLoan(id, { value: totalDue }); // Send a bit more to cover rebate case.
                await tx.wait();
                showNotification("Loan repaid successfully!", "success");
            } catch (error) {
                console.error("Repay loan failed:", error);
                showNotification(error.data ? error.data.message : error.message, "error");
            }
        }

        async function claimCollateral(id) {
            try {
                showNotification(`Claiming collateral for Loan #${id}...`);
                const tx = await contract.claimCollateral(id);
                await tx.wait();
                showNotification("Collateral claimed successfully!", "success");
            } catch (error) {
                console.error("Claim collateral failed:", error);
                showNotification(error.data ? error.data.message : error.message, "error");
            }
        }

        function showNotification(message, type = "info") {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');

            notificationText.textContent = message;
            notification.classList.remove('bg-blue-600', 'bg-green-500', 'bg-red-600');

            if (type === "success") notification.classList.add('bg-green-500');
            else if (type === "error") notification.classList.add('bg-red-600');
            else notification.classList.add('bg-blue-600');

            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }

    </script>
</body>

</html>